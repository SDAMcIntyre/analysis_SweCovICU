---
title: "SweCovICU survival analysis"
output: html_notebook
---


```{r}
library(tidyverse)
library(readxl)
library(broom)
library(knitr)
library(kableExtra)
library(lme4)
library(janitor)

#### Read in the data ####
datafile <- 'Raw data/MichelleChew_SweCOVID ICU Study_Unique_25Jun_SM_smallerrorsfixed_npwd.xlsx'
basicdata <- read_excel(datafile, na='NULL', sheet = 'Basic data') %>% 
  mutate(Height = parse_number(Height),
         ArrivalWeight = parse_number(ArrivalWeight)) 

totalN <- nrow(basicdata)

diagnosisdata <- read_excel(datafile, na='NULL', sheet = 'AllDiagnoses', range = 'A1:UC1609')

SOFAdata <- read_excel(datafile, na='NULL', sheet = 'SOFA', range = 'A1:BX1609')

measuresdata <- read_excel(datafile, na='NULL', sheet = 'Measures', range = 'A1:BC1609')

SIRIdata <- read_excel(datafile, na='NULL', sheet = 'SIRI', range = 'A1:AZ1609')

```

No, ‘Days off registry After Admission’ may not be accurate since there might be a lag before the patient is ‘deregistered’. There should be a variable ‘Days to death’ but I can’t find it. Perhaps we didn’t do it? What you need to do is to create an extra column with ‘Days to death’ defined as ‘Off registry date (column AJ)’ minus ‘admission date (column V)’ minus DaysFromDischargeToOff-registry/Diseased (column AI)‘. This is a bit of a pain. Sorry about that. 

```{r echo=FALSE}

summarise_qvars <- function(df,varnames) {
  df %>% 
    summarise_at(vars(varnames),
                      list(median = ~median(., na.rm = TRUE),
                           Q1 = ~quantile(., 1/4, na.rm = TRUE),
                           Q3 = ~quantile(., 3/4, na.rm = TRUE),
                           min = ~min(., na.rm = TRUE),
                           max = ~max(., na.rm = TRUE),
                           n = ~sum(!is.na(.)),
                           missing.n = ~sum(is.na(.)),
                           missing.pct = ~100*sum(is.na(.))/n()
                           )) %>% 
  kable() %>% kable_styling(full_width = F)
}

survivaldata <- basicdata %>% 
  select(PersonalID,
         OffRegistryDate,
         AdmissionTime,
         `DaysFromDischargeToOff-registry/Diseased`
         ) %>% 
  mutate(OffRegDeceased = `DaysFromDischargeToOff-registry/Diseased` %>% parse_number(),
         DaysToDeath = as.Date(OffRegistryDate) - as.Date(AdmissionTime) - OffRegDeceased) 
  # tabyl(DaysToDeathValid,Deceased) %>%
  # adorn_totals(c('col','row')) %>%
  # adorn_title() %>%
  # kable() %>% kable_styling(full_width = F)

survivaldata %>% 
  summarise_qvars('DaysToDeath')

survivaldata$DaysToDeath %>% head()

```

